<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Qu·∫£n Tr·ªã ICOGroup</title>
    <link rel="stylesheet" href="add.css">
    <!-- Quill WYSIWYG -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Admin API Key (legacy; not required when session+CSRF is enabled). Remove or clear in production. -->
    <meta name="admin-api-key" content="">
</head>

<body>

    <header class="top-bar">
        <a href="home.html" class="logo">Trang Qu·∫£n Tr·ªã ICOGroup</a>
        <div class="user-control">
            <button class="nav-item" onclick="changePassword()">ƒê·ªïi m·∫≠t kh·∫©u</button>
            <button class="nav-item" onclick="logoutAdmin()">ƒêƒÉng Xu·∫•t</button>
        </div>
    </header>

    <main class="main-container">
        <aside class="sidebar">
            <div id="data-management-menu" class="menu-list active-menu">
                <h3>Qu·∫£n L√Ω D·ªØ Li·ªáu</h3>
                <ul>
                    <li class="menu-item active" data-view="user-list">Danh s√°ch ƒë∆°n h√†ng</li>
                    <li class="menu-item" data-view="other-data">Ch·ªânh s·ª≠a trang web</li>
                </ul>
            </div>

            
        </aside>

        <section class="content-area">
            <div id="user-list" class="content-view active-view">
                <h2>üìã Danh s√°ch Ng∆∞·ªùi d√πng ƒë√£ g·ª≠i th√¥ng tin</h2>
                <div class="table-controls" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm theo Ng√†y nh·∫≠n, T√™n, SƒêT, Ghi ch√∫..."
                        style="padding: 8px; border: 1px solid #ccc; flex-grow: 1;">
                    <button class="action-btn btn-update" onclick="exportUsersToTxt()">
                        üì• Xu·∫•t File TXT
                    </button>
                </div>

                <div id="message"></div>
                <div id="userTableContainer">
                    <p style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>

                <div id="editModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h2>Ch·ªânh S·ª≠a Th√¥ng Tin Ng∆∞·ªùi D√πng</h2>
                        <form id="editUserForm">
                            <input type="hidden" id="edit-id" name="id">

                            <label for="edit-ho_ten">H·ªç v√† T√™n:</label>
                            <input type="text" id="edit-ho_ten" name="ho_ten" required>

                            <label for="edit-sdt">S·ªë ƒêi·ªán Tho·∫°i:</label>
                            <input type="tel" id="edit-sdt" name="sdt" required>

                            <label for="edit-nam_sinh">NƒÉm Sinh:</label>
                            <input type="number" id="edit-nam_sinh" name="nam_sinh">

                            <label for="edit-dia_chi">ƒê·ªãa Ch·ªâ:</label>
                            <input type="text" id="edit-dia_chi" name="dia_chi">

                            <label for="edit-chuong_trinh">Ch∆∞∆°ng Tr√¨nh:</label>
                            <select id="edit-chuong_trinh" name="chuong_trinh">
                                <option value="Du h·ªçc">Du h·ªçc</option>
                                <option value="Xu·∫•t kh·∫©u lao ƒë·ªông">Xu·∫•t kh·∫©u lao ƒë·ªông</option>
                                <option value="ƒê√†o t·∫°o ngo·∫°i ng·ªØ">ƒê√†o t·∫°o ngo·∫°i ng·ªØ</option>
                            </select>

                            <label for="edit-quoc_gia">Qu·ªëc Gia:</label>
                            <select id="edit-quoc_gia" name="quoc_gia">
                                <option value="Nh·∫≠t B·∫£n">Nh·∫≠t B·∫£n</option>
                                <option value="H√†n Qu·ªëc">H√†n Qu·ªëc</option>
                                <option value="ƒê√†i Loan">ƒê√†i Loan</option>
                                <option value="ƒê·ª©c">ƒê·ª©c</option>
                                <option value="Kh√°c">Kh√°c</option>
                            </select>

                            <label for="edit-ghi_chu">Ghi Ch√∫:</label>
                            <input type="text" id="edit-ghi_chu" name="ghi_chu">

                            <label for="edit-quan_ly_don_hang">Qu·∫£n L√Ω ƒê∆°n H√†ng:</label>
                            <select id="edit-quan_ly_don_hang" name="quan_ly_don_hang">
                                <option value="M·ªõi">M·ªõi</option>
                                <option value="ƒêang x·ª≠ l√Ω">ƒêang x·ª≠ l√Ω</option>
                                <option value="ƒê√£ Ph·ªèng V·∫•n">ƒê√£ Ph·ªèng V·∫•n</option>
                                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                                <option value="H·ªßy b·ªè">H·ªßy b·ªè</option>
                            </select>

                            <button type="submit" class="btn-update action-btn"
                                style="width: 100%; margin-top: 15px;">L∆ØU THAY ƒê·ªîI</button>
                        </form>
                    </div>
                </div>

                <!-- Quill JS -->
                <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

                <script>
                    const API_BASE_URL = '/web8s/backend_api/';
                    
                    const tableContainer = document.getElementById('userTableContainer');
                    const messageDisplay = document.getElementById('message');
                    const editModal = document.getElementById('editModal');
                    const editForm = document.getElementById('editUserForm');
                    const modalClose = document.getElementsByClassName("close")[0];
                    const searchInput = document.getElementById('searchInput');

                    // Quill editors map (initialized later)
                    window.quillEditors = window.quillEditors || {};

                    // Helper to build authentication headers (API key or CSRF token)
                    window.getAuthHeaders = function(contentType = true) {
                        const headers = {};
                        try {
                            const adminKey = document.querySelector('meta[name="admin-api-key"]')?.getAttribute('content');
                            if (adminKey) headers['X-ADMIN-KEY'] = adminKey;
                        } catch (e) {}
                        if (window.CSRF_TOKEN) headers['X-CSRF-Token'] = window.CSRF_TOKEN;
                        if (contentType) headers['Content-Type'] = 'application/json';
                        return headers;
                    };

                    function initQuillEditors() {
                        document.querySelectorAll('.quill-editor').forEach(div => {
                            const key = div.getAttribute('data-key');
                            // Avoid re-initializing
                            if (window.quillEditors[key]) return;
                            const quill = new Quill(div, {
                                theme: 'snow',
                                modules: {
                                    toolbar: [['bold','italic','underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link']]
                                }
                            });
                            window.quillEditors[key] = quill;
                        });
                    }

                    // H√†m hi·ªÉn th·ªã th√¥ng b√°o
                    function showMessage(msg, isSuccess = true) {
                        messageDisplay.textContent = msg;
                        messageDisplay.style.backgroundColor = isSuccess ? '#d4edda' : '#f8d7da';
                        messageDisplay.style.color = isSuccess ? '#155724' : '#721c24';
                    }

                    // ----------------------------------------------------------------------
                    // 1. CH·ª®C NƒÇNG ƒê·ªåC (READ)
                    // ----------------------------------------------------------------------

                    async function fetchUsers() {
                        // L∆∞u d·ªØ li·ªáu v√†o bi·∫øn global ƒë·ªÉ t√°i s·ª≠ d·ª•ng gi·ªØa c√°c tab
                        window.allUsers = window.allUsers || [];
                        tableContainer.innerHTML = '<p style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</p>';
                        showMessage("ƒêang t·∫£i danh s√°ch ng∆∞·ªùi d√πng...", false);

                        try {
                            const response = await fetch(API_BASE_URL + 'get.php');
                            const users = await response.json();

                            if (response.ok && Array.isArray(users)) {
                                window.allUsers = users;
                                renderTable(window.allUsers);
                                showMessage(`T·∫£i th√†nh c√¥ng! C√≥ ${users.length} ng∆∞·ªùi d√πng.`, true);
                            } else if (response.ok && users.data && users.data.length === 0) {
                                tableContainer.innerHTML = '<p style="text-align:center; color:gray;">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c t√¨m th·∫•y.</p>';
                                showMessage("Kh√¥ng c√≥ d·ªØ li·ªáu ƒëƒÉng k√Ω n√†o.", true);
                            } else {
                                throw new Error(users.message || "L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ API.");
                            }
                        } catch (error) {
                            console.error('L·ªói Fetch:', error);
                            tableContainer.innerHTML = '<p style="text-align:center; color:red;">Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Backend. Vui l√≤ng ki·ªÉm tra XAMPP!</p>';
                            showMessage(`L·ªói: ${error.message}`, false);
                        }
                    }

                    // H√†m v·∫Ω b·∫£ng HTML
                    function renderTable(dataToDisplay) {
                        if (dataToDisplay.length === 0) {
                            tableContainer.innerHTML = '<p style="text-align:center; color:gray;">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c t√¨m th·∫•y.</p>';
                            return;
                        }

                        let tableHTML = '<table>';
                        tableHTML += '<thead><tr><th>ID</th><th>Ng√†y nh·∫≠n</th><th>H·ªç T√™n</th><th>SƒêT</th><th>NƒÉm Sinh</th><th>ƒê·ªãa Ch·ªâ</th><th>Ch∆∞∆°ng Tr√¨nh</th><th>Qu·ªëc Gia</th><th>Ghi Ch√∫</th><th>H√†nh ƒê·ªông</th></tr></thead>';
                        tableHTML += '<tbody>';

                        dataToDisplay.forEach(user => {

                            const formattedDate = user.ngay_nhan ? new Date(user.ngay_nhan).toLocaleString('vi-VN') : '-';

                            tableHTML += `
            <tr data-id="${user.id}">
                <td>${user.id}</td>
                <td>${formattedDate}</td>
                <td>${user.ho_ten}</td>
                <td>${user.sdt}</td>
                <td>${user.nam_sinh || '-'}</td>
                <td>${user.dia_chi || '-'}</td>
                <td>${user.chuong_trinh || '-'}</td>
                <td>${user.quoc_gia || '-'}</td>
                <td>${user.ghi_chu || '-'}</td>
                <td>${user.quan_ly_don_hang || '-'}</td>

                <td>
                    <button class="action-btn btn-update" onclick="openEditModal(
                            ${user.id},
                            '${user.ho_ten}',
                            '${user.sdt}',
                            '${user.nam_sinh}',
                            '${user.dia_chi}',
                            '${user.chuong_trinh}',
                            '${user.quoc_gia}',
                            '${user.ghi_chu}',
                            '${user.quan_ly_don_hang}'
                        )">S·ª≠a</button>
                    <button class="action-btn btn-delete" onclick="deleteUser(${user.id})">X√≥a</button>
                </td>
            </tr>
            `;
                        });

                        tableHTML += '</tbody></table>';
                        tableContainer.innerHTML = tableHTML;
                    }

        //----------------------------------------------------------------------------------------------------------------
                    // H√†m l·ªçc d·ªØ li·ªáu d·ª±a tr√™n input t√¨m ki·∫øm
                    function filterUsers() {
                        const searchTerm = searchInput.value.toLowerCase();

                        // L·ªçc m·∫£ng allUsers (d·ªØ li·ªáu g·ªëc)
                        const source = window.allUsers || [];
                        const filteredUsers = source.filter(user => {
                            // Chu·ªói ƒë·ªÉ t√¨m ki·∫øm (t√¨m ki·∫øm trong T√™n, SƒêT, Ghi ch√∫)
                            const searchString = `${user.ho_ten} ${user.sdt} ${user.ghi_chu} ${user.ngay_nhan} ${user.trang_thai}`.toLowerCase();
                            return searchString.includes(searchTerm);
                        });

                        // Hi·ªÉn th·ªã b·∫£ng v·ªõi d·ªØ li·ªáu ƒë√£ l·ªçc
                        renderTable(filteredUsers);

                        // C·∫≠p nh·∫≠t th√¥ng b√°o
                        if (searchTerm.trim() !== "") {
                            showMessage(`T√¨m th·∫•y ${filteredUsers.length} k·∫øt qu·∫£.`, true);
                        } else {
                            showMessage(`T·∫£i th√†nh c√¥ng! C√≥ ${source.length} ng∆∞·ªùi d√πng.`, true);
                        }
                    }

                    // Th√™m Listener cho √¥ t√¨m ki·∫øm
                    searchInput.addEventListener('keyup', filterUsers);

                    // -----------------------------------------------------------------------------------------------------------
                    // 2. CH·ª®C NƒÇNG X√ìA (DELETE)
                    // -----------------------------------------------------------------------------------------------------------

                    async function deleteUser(id) {
                        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng ID: ${id} kh√¥ng ? `)) {
                            return;
                        }

                        try {
                            const response = await fetch(API_BASE_URL + 'delete.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id: id })
                            });

                            const result = await response.json();

                            if (response.ok && result.status === true) {
                                showMessage(`X√≥a ng∆∞·ªùi d√πng ID ${id} th√†nh c√¥ng.`, true);
                                // T·∫£i l·∫°i danh s√°ch sau khi x√≥a
                                fetchUsers();
                            } else {
                                throw new Error(result.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh khi x√≥a.");
                            }

                        } catch (error) {
                            console.error('L·ªói Delete:', error);
                            showMessage(`‚ùå L·ªói x√≥a: ${error.message} `, false);
                        }
                    }

                    // -----------------------------------------------------------------------------------------------------
                    // 3. CH·ª®C NƒÇNG C·∫¨P NH·∫¨T (UPDATE)
                    // -------------------------------------------------------------------------------------------------------

                    // M·ªü Modal v√† ƒëi·ªÅn d·ªØ li·ªáu c≈© v√†o form
                    function openEditModal(id, ho_ten, sdt, nam_sinh, dia_chi, chuong_trinh, quoc_gia, ghi_chu, trang_thai) {
                        document.getElementById('edit-id').value = id;
                        document.getElementById('edit-ho_ten').value = ho_ten;
                        document.getElementById('edit-sdt').value = sdt;
                        document.getElementById('edit-nam_sinh').value = nam_sinh;
                        document.getElementById('edit-dia_chi').value = dia_chi;
                        document.getElementById('edit-chuong_trinh').value = chuong_trinh;
                        document.getElementById('edit-quoc_gia').value = quoc_gia;
                        document.getElementById('edit-ghi_chu').value = ghi_chu;
                        document.getElementById('edit-quan_ly_don_hang').value = trang_thai;

                        editModal.style.display = "block";
                    }

                    // ƒê√≥ng Modal khi click v√†o n√∫t X
                    modalClose.onclick = function () {
                        editModal.style.display = "none";
                    }

                    // ƒê√≥ng Modal khi click ra ngo√†i
                    window.onclick = function (event) {
                        if (event.target == editModal) {
                            editModal.style.display = "none";
                        }
                    }

                    // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t "L∆ØU THAY ƒê·ªîI" trong Modal
                    editForm.addEventListener('submit', async function (event) {
                        event.preventDefault();

                        const updatedData = {
                            id: document.getElementById('edit-id').value,
                            ho_ten: document.getElementById('edit-ho_ten').value,
                            sdt: document.getElementById('edit-sdt').value,
                            nam_sinh: document.getElementById('edit-nam_sinh').value,
                            dia_chi: document.getElementById('edit-dia_chi').value,
                            chuong_trinh: document.getElementById('edit-chuong_trinh').value,
                            quoc_gia: document.getElementById('edit-quoc_gia').value,
                            ghi_chu: document.getElementById('edit-ghi_chu').value,
                            quan_ly_don_hang: document.getElementById('edit-quan_ly_don_hang').value
                        };

                        showMessage("ƒêang l∆∞u thay ƒë·ªïi...", false);

                        try {
                            const response = await fetch(API_BASE_URL + 'update.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updatedData)
                            });

                            const result = await response.json();

                            if (response.ok && result.status === true) {
                                showMessage(result.message, true);
                                editModal.style.display = "none";
                                fetchUsers(); 
                            } else {
                                throw new Error(result.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh khi c·∫≠p nh·∫≠t.");
                            }

                        } catch (error) {
                            console.error('L·ªói Update:', error);
                            showMessage(`‚ùå L·ªói c·∫≠p nh·∫≠t: ${error.message} `, false);
                        }
                    });
                    // ----------------------------------------------------------------------
                    // 4. CH·ª®C NƒÇNG XU·∫§T FILE TXT
                    // ----------------------------------------------------------------------
                    async function exportUsersToTxt() {

                        try {
                            const response = await fetch(API_BASE_URL + 'export.php');

                            // KI·ªÇM TRA M√É TR·∫†NG TH√ÅI V√Ä N·ªòI DUNG PH·∫¢N H·ªíI (R·∫§T QUAN TR·ªåNG)
                            if (!response.ok) {
                                // N·∫øu m√£ tr·∫°ng th√°i l√† l·ªói (4xx, 5xx), c·ªë g·∫Øng ƒë·ªçc ph·∫£n h·ªìi l√† text ƒë·ªÉ xem l·ªói PHP
                                const errorText = await response.text();
                                console.error('L·ªói ph·∫£n h·ªìi API:', errorText);
                                // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói chung chung h∆°n cho ng∆∞·ªùi d√πng
                                throw new Error(`K·∫øt n·ªëi th√†nh c√¥ng nh∆∞ng API tr·∫£ v·ªÅ l·ªói(${response.status}).Vui l√≤ng ki·ªÉm tra Console(L·ªói PHP).`);
                            }

                            // C·ªë g·∫Øng ph√¢n t√≠ch ph·∫£n h·ªìi th√†nh JSON
                            const result = await response.json();

                            if (result.status === true && result.file_url) {

                                const fullUrl = API_BASE_URL.replace('/backend_api/', '/') + result.file_url;
                                const link = document.createElement('a');
                                link.href = fullUrl;
                                link.download = result.file_url.split('/').pop();
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            } else if (result.message) {

                                showMessage(`Th√¥ng b√°o: ${result.message} `, true);
                            } else {
                                throw new Error("L·ªói kh√¥ng x√°c ƒë·ªãnh khi xu·∫•t file.");
                            }
                        } catch (error) {
                            console.error('L·ªói Export:', error);
                            showMessage(`‚ùå L·ªói xu·∫•t file: ${error.message.includes('JSON') ? 'L·ªói API: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi JSON h·ª£p l·ªá (Ki·ªÉm tra l·ªói PHP tr√™n m√°y ch·ªß).' : error.message} `, false);
                        }
                    }
                    // T·ª± ƒë·ªông t·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c load
                    document.addEventListener('DOMContentLoaded', function () { initQuillEditors(); fetchUsers(); });
                    // ----------------------------------------------------

                    // H√†m hi·ªÉn th·ªã th√¥ng b√°o cho ph·∫ßn n·ªôi dung (d√πng id='content-message')
                    function showContentMessage(msg, isSuccess = true) {
                        const display = document.getElementById('content-message');
                        if (display) {
                            display.textContent = msg;
                            display.style.backgroundColor = isSuccess ? '#d4edda' : '#f8d7da';
                            display.style.color = isSuccess ? '#155724' : '#721c24';
                            display.style.padding = '10px';
                            display.style.borderRadius = '5px';
                        }
                    }

                    // ----------------------------------------------------
                    // CH·ª®C NƒÇNG T·∫¢I V√Ä L∆ØU N·ªòI DUNG WEB
                    // ----------------------------------------------------

                    // 4.1. T·∫£i n·ªôi dung hi·ªán t·∫°i v√† ƒëi·ªÅn v√†o form
                    async function fetchAllContent() {
                        try {
                            const response = await fetch(API_BASE_URL + 'get_content.php');
                            const contents = await response.json();

                            if (response.ok && Array.isArray(contents)) {
                                contents.forEach(item => {
                                    // S·ª¨A L·ªñI C√ö PH√ÅP: B·ªè d·∫•u c√°ch th·ª´a
                                    const inputElement = document.querySelector(`[data-key="${item.section_key}"]`);
                                    if (inputElement) {
                                        inputElement.value = item.content_value;
                                    }
                                    // N·∫øu c√≥ Quill editor cho key n√†y, c·∫≠p nh·∫≠t HTML
                                    if (window.quillEditors && window.quillEditors[item.section_key]) {
                                        try {
                                            window.quillEditors[item.section_key].root.innerHTML = item.content_value;
                                        } catch (e) {
                                            console.warn('Kh√¥ng th·ªÉ set n·ªôi dung Quill cho', item.section_key, e);
                                        }
                                    }

                                    // N·∫øu ƒë√¢y l√† ·∫£nh banner, hi·ªÉn th·ªã preview v√† l∆∞u v√†o hidden input
                                    if (item.section_key === 'banner_image') {
                                        const preview = document.getElementById('banner_image_preview');
                                        const hidden = document.getElementById('banner_image_url');
                                        const removeBtn = document.getElementById('removeBannerBtn');
                                        if (item.content_value) {
                                            hidden.value = item.content_value;
                                            const fullUrl = API_BASE_URL.replace('/backend_api/', '/') + item.content_value;
                                            preview.src = fullUrl;
                                            preview.style.display = 'block';
                                            if (removeBtn) removeBtn.style.display = 'inline-block';
                                        } else {
                                            hidden.value = '';
                                            if (preview) preview.style.display = 'none';
                                            if (removeBtn) removeBtn.style.display = 'none';
                                        }
                                    }
                                });
                            } else {
                                throw new Error(contents.message || "L·ªói khi t·∫£i n·ªôi dung web.");
                            }
                        } catch (error) {
                            console.error('L·ªói Fetch Content:', error);
                            showMessage(`‚ùå L·ªói t·∫£i n·ªôi dung: ${error.message} `, false);
                        }
                    }

                    // 4.2. L∆∞u m·ªôt c·∫∑p key/value
                    async function saveContent(key, value) {
                        try {
                            const response = await fetch(API_BASE_URL + 'save_content.php', {
                                method: 'POST',
                                headers: window.getAuthHeaders(true),
                                body: JSON.stringify({ section_key: key, content_value: value })
                            });
                            const result = await response.json();

                            if (!response.ok || result.status !== true) {
                                throw new Error(result.message || `L·ªói c·∫≠p nh·∫≠t ${key}.`);
                            }
                            return true;
                        } catch (error) {
                            console.error(`L·ªói l∆∞u n·ªôi dung ${key}: `, error);
                            return false;
                        }
                    }

                    // 4.3. L∆∞u t·∫•t c·∫£ n·ªôi dung trong form
                    async function saveAllContent() {
                        showContentMessage("ƒêang l∆∞u t·∫•t c·∫£ n·ªôi dung...", false);

                        // N·∫øu c√≥ ·∫£nh banner ƒë∆∞·ª£c ch·ªçn, upload tr∆∞·ªõc
                        const bannerFileInput = document.getElementById('banner_image_input');
                        const bannerHidden = document.getElementById('banner_image_url');
                        if (bannerFileInput && bannerFileInput.files && bannerFileInput.files.length > 0) {
                            showContentMessage("ƒêang upload ·∫£nh banner...", false);
                            const fd = new FormData();
                            fd.append('file', bannerFileInput.files[0]);
                            try {
                                const headers = {};
                                // Attach CSRF token if we have it
                                if (window.CSRF_TOKEN) headers['X-CSRF-Token'] = window.CSRF_TOKEN;
                                // Also attach legacy admin key if present
                                const adminKey = document.querySelector('meta[name="admin-api-key"]')?.getAttribute('content');
                                if (adminKey) headers['X-ADMIN-KEY'] = adminKey;

                                const resp = await fetch(API_BASE_URL + 'save_image.php', { method: 'POST', body: fd, headers });
                                const result = await resp.json();
                                if (resp.ok && result.status === true) {
                                    if (bannerHidden) bannerHidden.value = result.file_url;
                                    const preview = document.getElementById('banner_image_preview');
                                    if (preview) {
                                        preview.src = API_BASE_URL.replace('/backend_api/', '/') + result.file_url;
                                        preview.style.display = 'block';
                                    }
                                    showContentMessage('Upload ·∫£nh banner th√†nh c√¥ng.', true);
                                } else {
                                    showContentMessage('‚ùå Upload ·∫£nh th·∫•t b·∫°i: ' + (result.message || ''), false);
                                }
                            } catch (err) {
                                console.error('L·ªói upload', err);
                                showContentMessage('‚ùå L·ªói upload ·∫£nh: ' + err.message, false);
                            }
                        }

                        // N·∫øu c√≥ Quill editors, ƒë·ªìng b·ªô HTML v√†o c√°c textarea t∆∞∆°ng ·ª©ng tr∆∞·ªõc khi l∆∞u
                        if (window.quillEditors) {
                            for (const key in window.quillEditors) {
                                const ta = document.querySelector(`[data-key="${key}"]`);
                                if (ta) {
                                    try { ta.value = window.quillEditors[key].root.innerHTML; } catch (e) { console.warn('Sync Quill -> textarea failed', key, e); }
                                }
                            }
                        }

                        // Build headers for save actions (CSRF + legacy API key if present)
                        var globalSaveHeaders = window.getAuthHeaders(true);

                        const contentInputs = document.querySelectorAll('#editContentForm .content-input');
                        let successCount = 0;
                        let failCount = 0;

                        // Helper to save a single key quickly (used for delete banner)
                        async function saveKeyWithHeaders(k, v) {
                            try {
                                const resp = await fetch(API_BASE_URL + 'save_content.php', {
                                    method: 'POST',
                                    headers: window.getAuthHeaders(true),
                                    body: JSON.stringify({ section_key: k, content_value: v })
                                });
                                const r = await resp.json();
                                return resp.ok && r.status === true;
                            } catch (e) {
                                console.error('saveKeyWithHeaders error', e);
                                return false;
                            }
                        }

                        for (const input of contentInputs) {
                            const key = input.getAttribute('data-key');
                            const value = input.value;

                            const isSuccess = await saveContent(key, value);
                            if (isSuccess) {
                                successCount++;
                            } else {
                                failCount++;
                            }
                        }

                        if (failCount === 0) {
                            showContentMessage(`üéâ L∆∞u t·∫•t c·∫£ n·ªôi dung th√†nh c√¥ng!(${successCount} m·ª•c ƒë∆∞·ª£c c·∫≠p nh·∫≠t).`, true);
                        } else {
                            showContentMessage(`‚ö†Ô∏è Ho√†n th√†nh! ${successCount} m·ª•c th√†nh c√¥ng, ${failCount} m·ª•c th·∫•t b·∫°i.Vui l√≤ng ki·ªÉm tra Console.`, false);
                        }
                    }

                    // ----- XEM TR∆Ø·ªöC (Preview) -----
                    function sanitizeHTML(str) {
                        return String(str).replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
                    }

                    function openPreview() {
                        const inputs = document.querySelectorAll('#editContentForm .content-input');
                        const previewBody = document.getElementById('previewBody');
                        let html = '';

                        // Banner
                        const bannerText = document.querySelector('[data-key="banner_text"]')?.value || '';
                        html += `<div style="padding:20px 0; text-align:center; background:#f5f5f5; margin-bottom:10px;"><h1>${sanitizeHTML(bannerText)}</h1></div>`;

                        // Du h·ªçc
                        const duhocTitle = document.querySelector('[data-key="duhoc_title"]')?.value || '';
                        const duhocText = document.querySelector('[data-key="duhoc_text"]')?.value || '';
                        html += `<section style="margin-bottom:15px;"><h2>${sanitizeHTML(duhocTitle)}</h2><p>${sanitizeHTML(duhocText)}</p></section>`;

                        // XKLƒê
                        const xkldTitle = document.querySelector('[data-key="xklƒë_title"]')?.value || document.querySelector('[data-key="xkld_title"]')?.value || '';
                        const xkldText = document.querySelector('[data-key="xklƒë_text"]')?.value || document.querySelector('[data-key="xkld_text"]')?.value || '';
                        html += `<section style="margin-bottom:15px;"><h2>${sanitizeHTML(xkldTitle)}</h2><p>${sanitizeHTML(xkldText)}</p></section>`;

                        // Footer
                        const footerName = document.querySelector('[data-key="footer_company_name"]')?.value || '';
                        const footerAddress = document.querySelector('[data-key="footer_address"]')?.value || '';
                        html += `<footer style="background:#002b6f; color:white; padding:20px; margin-top:20px;"><h3>${sanitizeHTML(footerName)}</h3><div>${sanitizeHTML(footerAddress)}</div></footer>`;

                        previewBody.innerHTML = html;
                        document.getElementById('previewModal').style.display = 'block';
                    }

                    document.getElementById('previewClose').onclick = function () {
                        document.getElementById('previewModal').style.display = 'none';
                    }

                    window.addEventListener('click', function (ev) {
                        const previewModal = document.getElementById('previewModal');
                        if (ev.target == previewModal) {
                            previewModal.style.display = 'none';
                        }
                    });

                    // Preview ·∫£nh banner khi ch·ªçn file
                    const bannerInput = document.getElementById('banner_image_input');
                    if (bannerInput) {
                        bannerInput.addEventListener('change', function () {
                            const f = this.files && this.files[0];
                            const preview = document.getElementById('banner_image_preview');
                            const removeBtn = document.getElementById('removeBannerBtn');
                            if (f && preview) {
                                preview.src = URL.createObjectURL(f);
                                preview.style.display = 'block';
                                if (removeBtn) removeBtn.style.display = 'inline-block';
                            } else if (preview) {
                                preview.src = '';
                                preview.style.display = 'none';
                                if (removeBtn) removeBtn.style.display = 'none';
                            }
                        });
                    }

                    // Remove banner (clear value and call save key to remove from DB and delete file server-side)
                    const removeBannerBtn = document.getElementById('removeBannerBtn');
                    if (removeBannerBtn) {
                        removeBannerBtn.addEventListener('click', async function () {
                            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh banner hi·ªán t·∫°i kh√¥ng?')) return;
                            // Clear preview & hidden input
                            const preview = document.getElementById('banner_image_preview');
                            const hidden = document.getElementById('banner_image_url');
                            if (preview) { preview.src = ''; preview.style.display = 'none'; }
                            if (hidden) { hidden.value = ''; }
                            // Call server to clear banner_image (server will delete file)
                            const ok = await saveKeyWithHeaders('banner_image', '');
                            if (ok) {
                                showContentMessage('·∫¢nh banner ƒë√£ ƒë∆∞·ª£c x√≥a.', true);
                                if (removeBannerBtn) removeBannerBtn.style.display = 'none';
                            } else {
                                showContentMessage('Kh√¥ng th·ªÉ x√≥a ·∫£nh banner. Ki·ªÉm tra Console.', false);
                            }
                        });
                    }

                    // T·ª± ƒë·ªông t·∫£i n·ªôi dung khi chuy·ªÉn sang tab Qu·∫£n l√Ω N·ªôi dung
                    // G·∫Øn s·ª± ki·ªán cho m·ª•c Sidebar "Ch·ªânh s·ª≠a trang web" (data-view="other-data")
                    const webContentSidebarItem = document.querySelector('[data-view="other-data"]');
                    if (webContentSidebarItem) {
                        webContentSidebarItem.addEventListener('click', fetchAllContent);
                    }

                    // N·∫øu tab "other-data" ƒëang active khi trang load, t·ª± ƒë·ªông t·∫£i n·ªôi dung
                    const otherDataView = document.getElementById('other-data');
                    if (otherDataView && otherDataView.classList.contains('active-view')) {
                        fetchAllContent();
                    }
                </script>

            </div>

        

            <div id="other-data" class="content-view">
                <h2>üìö Qu·∫£n l√Ω n·ªôi dung trang web</h2>

                <div class="table-controls" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="searchInputOther" placeholder="T√¨m ki·∫øm ID, Ng√†y nh·∫≠n, T√™n, SƒêT, Ghi ch√∫..."
                        style="padding: 8px; border: 1px solid #ccc; flex-grow: 1;">
                    <button class="action-btn btn-update" onclick="exportUsersToTxt()">
                        üì• Xu·∫•t File TXT
                    </button>
                </div>

                <div id="content-message" style="margin-bottom: 15px;"></div>

                <form id="editContentForm">
                    <h3>1. Ph·∫ßn BANNER</h3>
                    <label for="banner_text_input">Text Banner:</label>
                    <textarea id="banner_text_input" data-key="banner_text" class="content-input" rows="2" style="display:none;"></textarea>
                    <div id="banner_text_input_quill" class="quill-editor" data-key="banner_text" style="border:1px solid #ccc; border-radius:4px; min-height:56px;"></div>

                    <label for="banner_image_input" style="margin-top:10px; display:block;">·∫¢nh Banner (png/jpg/gif):</label>
                    <input type="file" id="banner_image_input" accept="image/*">
                    <input type="hidden" id="banner_image_url" data-key="banner_image" class="content-input">
                    <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                        <img id="banner_image_preview" src="" alt="Banner preview" style="max-width:100%; max-height:120px; display:none; border:1px solid #ddd; padding:4px; border-radius:4px;" />
                        <button type="button" id="removeBannerBtn" class="action-btn btn-delete" style="display:none;">X√≥a ·∫£nh</button>
                    </div>

                    <h3>2. Ph·∫ßn TWO-COLUMN SECTION</h3>
                    <label for="duhoc_title_input">Ti√™u ƒë·ªÅ Du H·ªçc (H2):</label>
                    <input type="text" id="duhoc_title_input" data-key="duhoc_title" class="content-input">

                    <label for="duhoc_text_input">ƒêo·∫°n vƒÉn Du H·ªçc (P):</label>
                    <textarea id="duhoc_text_input" data-key="duhoc_text" class="content-input" rows="3" style="display:none;"></textarea>
                    <div id="duhoc_text_input_quill" class="quill-editor" data-key="duhoc_text" style="border:1px solid #ccc; border-radius:4px; min-height:80px;"></div>

                    <hr>

                    <label for="xklƒë_title_input">Ti√™u ƒë·ªÅ XKLƒê (H2):</label>
                    <input type="text" id="xklƒë_title_input" data-key="xklƒë_title" class="content-input">

                    <label for="xklƒë_text_input">ƒêo·∫°n vƒÉn XKLƒê (P):</label>
                    <textarea id="xklƒë_text_input" data-key="xklƒë_text" class="content-input" rows="3" style="display:none;"></textarea>
                    <div id="xklƒë_text_input_quill" class="quill-editor" data-key="xklƒë_text" style="border:1px solid #ccc; border-radius:4px; min-height:80px;"></div>

                    <h3>3. Ph·∫ßn HO·∫†T ƒê·ªòNG</h3>
                    <label for="hoatdong_title_input">Ti√™u ƒë·ªÅ Ho·∫°t ƒë·ªông (H2):</label>
                    <input type="text" id="hoatdong_title_input" data-key="hoatdong_title" class="content-input">

                    <label for="hoatdong_text_input">N·ªôi dung Ho·∫°t ƒë·ªông:</label>
                    <textarea id="hoatdong_text_input" data-key="hoatdong_text" class="content-input" rows="3" style="display:none;"></textarea>
                    <div id="hoatdong_text_input_quill" class="quill-editor" data-key="hoatdong_text" style="border:1px solid #ccc; border-radius:4px; min-height:80px;"></div>

                    <h3>4. Ph·∫ßn LI√äN H·ªÜ</h3>
                    <label for="lienhe_title_input">Ti√™u ƒë·ªÅ Li√™n h·ªá (H2):</label>
                    <input type="text" id="lienhe_title_input" data-key="lienhe_title" class="content-input">

                    <label for="lienhe_text_input">N·ªôi dung Li√™n H·ªá:</label>
                    <textarea id="lienhe_text_input" data-key="lienhe_text" class="content-input" rows="3" style="display:none;"></textarea>
                    <div id="lienhe_text_input_quill" class="quill-editor" data-key="lienhe_text" style="border:1px solid #ccc; border-radius:4px; min-height:80px;"></div>

                    <h3>3. Ph·∫ßn FOOTER</h3>
                    <label for="footer_company_name_input">T√™n C√¥ng ty (Footer):</label>
                    <input type="text" id="footer_company_name_input" data-key="footer_company_name"
                        class="content-input">

                    <label for="footer_address_input">ƒê·ªãa ch·ªâ (Footer):</label>
                    <textarea id="footer_address_input" data-key="footer_address" class="content-input" rows="2" style="display:none;"></textarea>
                    <div id="footer_address_input_quill" class="quill-editor" data-key="footer_address" style="border:1px solid #ccc; border-radius:4px; min-height:60px;"></div>


                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button type="button" onclick="openPreview()" class="btn-update action-btn" style="background:#007bff; color:white;">XEM TR∆Ø·ªöC</button>
                        <button type="button" onclick="saveAllContent()" class="btn-update action-btn" style="margin-left:auto;">L∆ØU T·∫§T C·∫¢ N·ªòI DUNG</button>
                    </div>
                </form>

                <!-- Preview Modal -->
                <div id="previewModal" class="modal" style="display:none;">
                    <div class="modal-content" style="max-width:800px; width:95%;">
                        <span class="close" id="previewClose">&times;</span>
                        <h2>Xem tr∆∞·ªõc n·ªôi dung trang</h2>
                        <div id="previewBody" style="padding:10px; max-height:60vh; overflow:auto; border-top:1px solid #eee;">
                            <!-- Rendered preview inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="add.js"></script>
</body>

</html>
