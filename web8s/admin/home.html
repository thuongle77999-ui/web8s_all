<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Qu·∫£n Tr·ªã ICOGroup</title>
    <link rel="stylesheet" href="add.css">
</head>

<body>

    <header class="top-bar">
        <a href="home.html" class="logo">Trang Qu·∫£n Tr·ªã ICOGroup</a>
        <nav class="main-nav">
            <button class="nav-item active" data-content="data-management">Qu·∫£n l√Ω D·ªØ li·ªáu</button>
            <button class="nav-item" data-content="web-content-management">Qu·∫£n l√Ω N·ªôi dung Web</button>
        </nav>
        <div class="user-control">
            <button class="nav-item" onclick="logoutAdmin()">ƒêƒÉng Xu·∫•t</button>
        </div>
    </header>

    <main class="main-container">
        <aside class="sidebar">
            <div id="data-management-menu" class="menu-list active-menu">
                <h3>Qu·∫£n L√Ω D·ªØ Li·ªáu</h3>
                <ul>
                    <li class="menu-item active" data-view="user-list">Danh s√°ch Ng∆∞·ªùi d√πng</li>
                    <li class="menu-item" data-view="other-data">Qu·∫£n l√Ω D·ªØ li·ªáu Kh√°c</li>
                </ul>
            </div>

            <div id="web-content-management-menu" class="menu-list">
                <h3>Qu·∫£n L√Ω N·ªôi Dung</h3>
                <ul>
                    <li class="menu-item active" data-view="page-structure">C·∫•u tr√∫c Trang</li>
                    <li class="menu-item" data-view="text-edit">S·ª≠a VƒÉn B·∫£n/Ti√™u ƒë·ªÅ</li>
                    <li class="menu-item" data-view="image-management">Qu·∫£n l√Ω H√¨nh ·∫£nh</li>
                </ul>
            </div>
        </aside>

        <section class="content-area">
            <div id="user-list" class="content-view active-view">
                <h2>üìã Danh s√°ch Ng∆∞·ªùi d√πng ƒë√£ g·ª≠i th√¥ng tin</h2>
                <div class="table-controls" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm theo T√™n, SƒêT, Ghi ch√∫..."
                        style="padding: 8px; border: 1px solid #ccc; flex-grow: 1;">
                    <button class="action-btn btn-update" onclick="exportUsersToTxt()">
                        üì• Xu·∫•t File TXT
                    </button>
                </div>

                <body>


                    <div id="message"></div>
                    <div id="userTableContainer">
                        <p style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                    </div>

                    <div id="editModal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h2>Ch·ªânh S·ª≠a Th√¥ng Tin Ng∆∞·ªùi D√πng</h2>
                            <form id="editUserForm">
                                <input type="hidden" id="edit-id" name="id">

                                <label for="edit-ho_ten">H·ªç v√† T√™n:</label>
                                <input type="text" id="edit-ho_ten" name="ho_ten" required>

                                <label for="edit-sdt">S·ªë ƒêi·ªán Tho·∫°i:</label>
                                <input type="tel" id="edit-sdt" name="sdt" required>

                                <label for="edit-nam_sinh">NƒÉm Sinh:</label>
                                <input type="number" id="edit-nam_sinh" name="nam_sinh">

                                <label for="edit-dia_chi">ƒê·ªãa Ch·ªâ:</label>
                                <input type="text" id="edit-dia_chi" name="dia_chi">

                                <label for="edit-chuong_trinh">Ch∆∞∆°ng Tr√¨nh:</label>
                                <select id="edit-chuong_trinh" name="chuong_trinh">
                                    <option value="Du h·ªçc">Du h·ªçc</option>
                                    <option value="Xu·∫•t kh·∫©u lao ƒë·ªông">Xu·∫•t kh·∫©u lao ƒë·ªông</option>
                                    <option value="ƒê√†o t·∫°o ngo·∫°i ng·ªØ">ƒê√†o t·∫°o ngo·∫°i ng·ªØ</option>
                                </select>

                                <label for="edit-quoc_gia">Qu·ªëc Gia:</label>
                                <select id="edit-quoc_gia" name="quoc_gia">
                                    <option value="Nh·∫≠t B·∫£n">Nh·∫≠t B·∫£n</option>
                                    <option value="H√†n Qu·ªëc">H√†n Qu·ªëc</option>
                                    <option value="ƒê√†i Loan">ƒê√†i Loan</option>
                                    <option value="ƒê·ª©c">ƒê·ª©c</option>
                                    <option value="Kh√°c">Kh√°c</option>
                                </select>

                                <label for="edit-ghi_chu">Ghi Ch√∫:</label>
                                <input type="text" id="edit-ghi_chu" name="ghi_chu">

                                <button type="submit" class="btn-update action-btn"
                                    style="width: 100%; margin-top: 15px;">L∆ØU THAY ƒê·ªîI</button>
                            </form>
                        </div>
                    </div>

                    <script>
                        const API_BASE_URL = 'http://localhost/web8s/backend_api/';
                        const tableContainer = document.getElementById('userTableContainer');
                        const messageDisplay = document.getElementById('message');
                        const editModal = document.getElementById('editModal');
                        const editForm = document.getElementById('editUserForm');
                        const modalClose = document.getElementsByClassName("close")[0];

                        // H√†m hi·ªÉn th·ªã th√¥ng b√°o
                        function showMessage(msg, isSuccess = true) {
                            messageDisplay.textContent = msg;
                            messageDisplay.style.backgroundColor = isSuccess ? '#d4edda' : '#f8d7da';
                            messageDisplay.style.color = isSuccess ? '#155724' : '#721c24';
                        }

                        // ----------------------------------------------------------------------
                        // 1. CH·ª®C NƒÇNG ƒê·ªåC (READ)
                        // ----------------------------------------------------------------------

                        async function fetchUsers() {
                            tableContainer.innerHTML = '<p style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</p>';
                            showMessage("ƒêang t·∫£i danh s√°ch ng∆∞·ªùi d√πng...", false);

                            try {
                                const response = await fetch(API_BASE_URL + 'get.php');
                                const users = await response.json();

                                if (response.ok && Array.isArray(users)) {
                                    allUsers = users;
                                    renderTable(allUsers);
                                    showMessage(`T·∫£i th√†nh c√¥ng! C√≥ ${users.length} ng∆∞·ªùi d√πng.`, true);
                                } else if (response.ok && users.data && users.data.length === 0) {
                                    tableContainer.innerHTML = '<p style="text-align:center; color:gray;">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c t√¨m th·∫•y.</p>';
                                    showMessage("Kh√¥ng c√≥ d·ªØ li·ªáu ƒëƒÉng k√Ω n√†o.", true);
                                } else {
                                    throw new Error(users.message || "L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ API.");
                                }
                            } catch (error) {
                                console.error('L·ªói Fetch:', error);
                                tableContainer.innerHTML = '<p style="text-align:center; color:red;">Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Backend. Vui l√≤ng ki·ªÉm tra XAMPP!</p>';
                                showMessage(`L·ªói: ${error.message}`, false);
                            }
                        }

                        // H√†m v·∫Ω b·∫£ng HTML
                        function renderTable(dataToDisplay) {
                            if (dataToDisplay.length === 0) {
                                tableContainer.innerHTML = '<p style="text-align:center; color:gray;">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c t√¨m th·∫•y.</p>';
                                return;
                            }

                            let tableHTML = '<table>';
                            tableHTML += '<thead><tr><th>ID</th><th>Ng√†y nh·∫≠n</th><th>H·ªç T√™n</th><th>SƒêT</th><th>NƒÉm Sinh</th><th>ƒê·ªãa Ch·ªâ</th><th>Ch∆∞∆°ng Tr√¨nh</th><th>Qu·ªëc Gia</th><th>Ghi Ch√∫</th><th>H√†nh ƒê·ªông</th></tr></thead>';
                            tableHTML += '<tbody>';

                            dataToDisplay.forEach(user => {
                                // ƒê·ªãnh d·∫°ng l·∫°i ng√†y gi·ªù
                                const formattedDate = user.ngay_nhan ? new Date(user.ngay_nhan).toLocaleString('vi-VN') : '-';
                                tableHTML += `
                    <tr data-id="${user.id}">
                        <td>${user.id}</td>
                        <td>${formattedDate}</td>
                        <td>${user.ho_ten}</td>
                        <td>${user.sdt}</td>
                        <td>${user.nam_sinh || '-'}</td>

                        <td>${user.dia_chi || '-'}</td>
                        <td>${user.chuong_trinh || '-'}</td>
                        <td>${user.quoc_gia || '-'}</td>
                        
                        <td>${user.ghi_chu || '-'}</td>
                        <td>
                            <button class="action-btn btn-update" onclick="openEditModal(${user.id}, '${user.ho_ten}', '${user.sdt}', '${user.nam_sinh}', '${user.dia_chi}', '${user.chuong_trinh}', '${user.quoc_gia}', '${user.ghi_chu}')">S·ª≠a</button>
                            <button class="action-btn btn-delete" onclick="deleteUser(${user.id})">X√≥a</button>
                        </td>
                    </tr>
                `;
                            });

                            tableHTML += '</tbody></table>';
                            tableContainer.innerHTML = tableHTML;
                        }
                        // H√†m l·ªçc d·ªØ li·ªáu d·ª±a tr√™n input t√¨m ki·∫øm
                        function filterUsers() {
                            const searchTerm = searchInput.value.toLowerCase();

                            // L·ªçc m·∫£ng allUsers (d·ªØ li·ªáu g·ªëc)
                            const filteredUsers = allUsers.filter(user => {
                                // Chu·ªói ƒë·ªÉ t√¨m ki·∫øm (t√¨m ki·∫øm trong T√™n, SƒêT, Ghi ch√∫)
                                const searchString = `${user.ho_ten} ${user.sdt} ${user.ghi_chu}`.toLowerCase();
                                return searchString.includes(searchTerm);
                            });

                            // Hi·ªÉn th·ªã b·∫£ng v·ªõi d·ªØ li·ªáu ƒë√£ l·ªçc
                            renderTable(filteredUsers);

                            // C·∫≠p nh·∫≠t th√¥ng b√°o
                            if (searchTerm.trim() !== "") {
                                showMessage(`T√¨m th·∫•y ${filteredUsers.length} k·∫øt qu·∫£.`, true);
                            } else {
                                showMessage(`T·∫£i th√†nh c√¥ng! C√≥ ${allUsers.length} ng∆∞·ªùi d√πng.`, true);
                            }
                        }

                        // Th√™m Listener cho √¥ t√¨m ki·∫øm
                        searchInput.addEventListener('keyup', filterUsers);

                        // ----------------------------------------------------------------------
                        // 2. CH·ª®C NƒÇNG X√ìA (DELETE)
                        // ----------------------------------------------------------------------

                        async function deleteUser(id) {
                            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng ID: ${id} kh√¥ng?`)) {
                                return;
                            }

                            try {
                                const response = await fetch(API_BASE_URL + 'delete.php', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ id: id })
                                });

                                const result = await response.json();

                                if (response.ok && result.status === true) {
                                    showMessage(`X√≥a ng∆∞·ªùi d√πng ID ${id} th√†nh c√¥ng.`, true);
                                    // T·∫£i l·∫°i danh s√°ch sau khi x√≥a
                                    fetchUsers();
                                } else {
                                    throw new Error(result.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh khi x√≥a.");
                                }

                            } catch (error) {
                                console.error('L·ªói Delete:', error);
                                showMessage(`‚ùå L·ªói x√≥a: ${error.message}`, false);
                            }
                        }

                        // ----------------------------------------------------------------------
                        // 3. CH·ª®C NƒÇNG C·∫¨P NH·∫¨T (UPDATE)
                        // ----------------------------------------------------------------------

                        // M·ªü Modal v√† ƒëi·ªÅn d·ªØ li·ªáu c≈© v√†o form
                        function openEditModal(id, ho_ten, sdt, nam_sinh, dia_chi, chuong_trinh, quoc_gia, ghi_chu) {
                            document.getElementById('edit-id').value = id;
                            document.getElementById('edit-ho_ten').value = ho_ten;
                            document.getElementById('edit-sdt').value = sdt;
                            document.getElementById('edit-nam_sinh').value = nam_sinh;
                            document.getElementById('edit-dia_chi').value = dia_chi;
                            document.getElementById('edit-chuong_trinh').value = chuong_trinh;
                            document.getElementById('edit-quoc_gia').value = quoc_gia;
                            document.getElementById('edit-ghi_chu').value = ghi_chu;

                            editModal.style.display = "block";
                        }

                        // ƒê√≥ng Modal khi click v√†o n√∫t X
                        modalClose.onclick = function () {
                            editModal.style.display = "none";
                        }

                        // ƒê√≥ng Modal khi click ra ngo√†i
                        window.onclick = function (event) {
                            if (event.target == editModal) {
                                editModal.style.display = "none";
                            }
                        }

                        // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t "L∆ØU THAY ƒê·ªîI" trong Modal
                        editForm.addEventListener('submit', async function (event) {
                            event.preventDefault();

                            const updatedData = {
                                id: document.getElementById('edit-id').value,
                                ho_ten: document.getElementById('edit-ho_ten').value,
                                sdt: document.getElementById('edit-sdt').value,
                                nam_sinh: document.getElementById('edit-nam_sinh').value,
                                dia_chi: document.getElementById('edit-dia_chi').value,
                                chuong_trinh: document.getElementById('edit-chuong_trinh').value,
                                quoc_gia: document.getElementById('edit-quoc_gia').value,
                                ghi_chu: document.getElementById('edit-ghi_chu').value
                            };

                            showMessage("ƒêang l∆∞u thay ƒë·ªïi...", false);

                            try {
                                const response = await fetch(API_BASE_URL + 'update.php', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(updatedData)
                                });

                                const result = await response.json();

                                if (response.ok && result.status === true) {
                                    showMessage(result.message, true);
                                    editModal.style.display = "none"; // ƒê√≥ng Modal
                                    fetchUsers(); // T·∫£i l·∫°i d·ªØ li·ªáu
                                } else {
                                    throw new Error(result.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh khi c·∫≠p nh·∫≠t.");
                                }

                            } catch (error) {
                                console.error('L·ªói Update:', error);
                                showMessage(`‚ùå L·ªói c·∫≠p nh·∫≠t: ${error.message}`, false);
                            }
                        });
                        // ----------------------------------------------------------------------
                        // 4. CH·ª®C NƒÇNG XU·∫§T FILE TXT
                        // ----------------------------------------------------------------------
                        async function exportUsersToTxt() {
                            showMessage("ƒêang chu·∫©n b·ªã file TXT...", false);

                            try {
                                // G·ªåI API export_to_txt.php
                                const response = await fetch(API_BASE_URL + 'export_to_txt.php');
                                const result = await response.json();

                                if (response.ok && result.status === true && result.file_url) {
                                    showMessage(`Xu·∫•t file th√†nh c√¥ng! B·∫Øt ƒë·∫ßu t·∫£i xu·ªëng...`, true);
                                    // T·∫°o link t·∫£i xu·ªëng t·∫°m th·ªùi v√† k√≠ch ho·∫°t click
                                    const fullUrl = API_BASE_URL.replace('/backend_api/', '/') + result.file_url;
                                    const link = document.createElement('a');
                                    link.href = fullUrl;
                                    link.download = result.file_url.split('/').pop(); // L·∫•y t√™n file
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                } else if (result.message) {
                                    showMessage(`Th√¥ng b√°o: ${result.message}`, true);
                                } else {
                                    throw new Error("L·ªói kh√¥ng x√°c ƒë·ªãnh khi xu·∫•t file.");
                                }
                            } catch (error) {
                                console.error('L·ªói Export:', error);
                                showMessage(`‚ùå L·ªói xu·∫•t file: ${error.message}`, false);
                            }
                        }
                        // T·ª± ƒë·ªông t·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c load
                        document.addEventListener('DOMContentLoaded', fetchUsers);
                    </script>

                </body>

                <div id="page-structure" class="content-view">
                    <h2>‚öôÔ∏è Qu·∫£n l√Ω C·∫•u tr√∫c Trang Web</h2>
                    <p>ƒê√¢y l√† khu v·ª±c ƒë·ªÉ s·ª≠a n·ªôi dung c·ªßa trang web. B·ªë c·ª•c n√†y m√¥ ph·ªèng c·∫•u tr√∫c 3 h√†ng/3 c·ªôt t·ª´ H√¨nh
                        2.</p>

                    <div class="web-layout-mockup">
                        <div class="row">
                            <div class="cell">H√†ng 1, C·ªôt 1</div>
                            <div class="cell">H√†ng 1, C·ªôt 2</div>
                            <div class="cell">H√†ng 1, C·ªôt 3</div>
                        </div>
                        <div class="row">
                            <div class="cell">H√†ng 2, C·ªôt 1: ·∫¢nh</div>
                            <div class="cell">H√†ng 2, C·ªôt 2: Text</div>
                            <div class="cell">H√†ng 2, C·ªôt 3</div>
                        </div>
                        <div class="row">
                            <div class="cell">H√†ng 3, C·ªôt 1: Icon</div>
                            <div class="cell">H√†ng 3, C·ªôt 2: Multi-Text</div>
                            <div class="cell">H√†ng 3, C·ªôt 3: Map</div>
                        </div>
                    </div>
                </div>

                <div id="other-data" class="content-view">
                    <h2>üìö Qu·∫£n l√Ω D·ªØ li·ªáu Kh√°c</h2>
                    <p>N·ªôi dung qu·∫£n l√Ω c√°c lo·∫°i d·ªØ li·ªáu kh√°c ngo√†i ng∆∞·ªùi d√πng.</p>
                </div>
                <div id="text-edit" class="content-view">
                    <h2>üìù S·ª≠a VƒÉn B·∫£n/Ti√™u ƒë·ªÅ</h2>
                    <p>C√°c form ch·ªânh s·ª≠a n·ªôi dung vƒÉn b·∫£n tr·ª±c ti·∫øp tr√™n web.</p>
                </div>
                <div id="image-management" class="content-view">
                    <h2>üñºÔ∏è Qu·∫£n l√Ω H√¨nh ·∫£nh</h2>
                    <p>Upload, thay th·∫ø, x√≥a h√¨nh ·∫£nh.</p>
                </div>
        </section>
    </main>

    <script src="add.js"></script>
</body>

</html>